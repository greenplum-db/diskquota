CREATE ROLE test SUPERUSER;
SET ROLE test;
CREATE TABLE t (i) AS SELECT generate_series(1, 100000);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT diskquota.wait_for_worker_new_epoch();
 wait_for_worker_new_epoch 
---------------------------
 t
(1 row)

SELECT tableid::regclass, size FROM diskquota.table_size
WHERE tableid = 't'::regclass AND segid = -1;
 tableid |  size   
---------+---------
 t       | 3637248
(1 row)

-- Ensure that t is not active
SELECT diskquota.diskquota_fetch_table_stat(0, ARRAY[]::oid[])
FROM gp_dist_random('gp_id');
 diskquota_fetch_table_stat 
----------------------------
(0 rows)

SELECT diskquota.set_role_quota(current_role, '1MB');
 set_role_quota 
----------------
 
(1 row)

SELECT diskquota.wait_for_worker_new_epoch();
 wait_for_worker_new_epoch 
---------------------------
 t
(1 row)

-- Expect that current role is in the blackmap 
SELECT rolname FROM pg_authid, diskquota.blackmap WHERE oid = target_oid;
 rolname 
---------
 test
(1 row)

SELECT diskquota.set_role_quota(current_role, '-1');
 set_role_quota 
----------------
 
(1 row)

SELECT diskquota.wait_for_worker_new_epoch();
 wait_for_worker_new_epoch 
---------------------------
 t
(1 row)

SELECT rolname FROM pg_authid, diskquota.blackmap WHERE oid = target_oid;
 rolname 
---------
(0 rows)

DROP TABLE t;
RESET ROLE;
DROP ROLE test;
